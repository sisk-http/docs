# Развертывание

Процесс развертывания приложения Sisk состоит в публикации вашего проекта в production. Хотя процесс относительно прост, стоит отметить детали, которые могут быть фатальными для безопасности и стабильности инфраструктуры развертывания.

В идеале вы должны быть готовы развернуть свое приложение в облако после проведения всех возможных тестов, чтобы убедиться, что оно готово к работе.

## Публикация вашего приложения

Публикация вашего приложения или службы Sisk заключается в создании готовых и оптимизированных для production бинарных файлов. В этом примере мы скомпилируем бинарные файлы для production, чтобы они работали на машине, на которой установлен .NET Runtime.

Вам понадобится .NET SDK, установленный на вашей машине, чтобы построить ваше приложение, и .NET Runtime, установленный на целевом сервере, чтобы запустить ваше приложение. Вы можете узнать, как установить .NET Runtime на вашем сервере Linux [здесь](https://learn.microsoft.com/en-us/dotnet/core/install/linux), [Windows](https://learn.microsoft.com/en-us/dotnet/core/install/windows?tabs=net70) и [Mac OS](https://learn.microsoft.com/en-us/dotnet/core/install/macos).

В папке, где находится ваш проект, откройте терминал и используйте команду .NET publish:

```shell
dotnet publish -r linux-x64 -c Release
```

Это создаст ваши бинарные файлы внутри `bin/Release/publish/linux-x64`.

> [!NOTE]
> Если ваше приложение работает с помощью пакета Sisk.ServiceProvider, вам следует скопировать ваш `service-config.json` на хост-сервер вместе со всеми сгенерированными `dotnet publish` бинарными файлами.
> Вы можете оставить файл предварительно настроенным с переменными среды, портами прослушивания, хостами и дополнительными конфигурациями сервера.

Следующим шагом является перемещение этих файлов на сервер, где будет размещено ваше приложение.

После этого предоставьте исполняемые права вашему бинарному файлу. В этом случае, предположим, что имя вашего проекта - "my-app":

```shell
cd /home/htdocs
chmod +x my-app
./my-app
```

После запуска вашего приложения проверьте, не выдает ли оно каких-либо сообщений об ошибках. Если ошибок нет, значит, ваше приложение запущено.

На этом этапе, вероятно, будет невозможно получить доступ к вашему приложению извне вашего сервера, так как не были настроены правила доступа, такие как брандмауэр. Мы рассмотрим это на следующих этапах.

У вас должен быть адрес виртуального хоста, на котором ваше приложение прослушивает. Это настраивается вручную в приложении и зависит от того, как вы создаете свою службу Sisk.

Если вы **не** используете пакет Sisk.ServiceProvider, вы должны найти его там, где вы определили экземпляр HttpServer:

```cs
HttpServer server = HttpServer.Emit(5000, out HttpServerConfiguration config, out var host, out var router);
// sisk должен прослушивать по http://localhost:5000/
```

Ассоциирование ListeningHost вручную:

```cs
config.ListeningHosts.Add(new ListeningHost("https://localhost:5000/", router));
```

Или если вы используете пакет Sisk.ServiceProvider, в вашем `service-config.json`:

```json
{
  "Server": { },
  "ListeningHost": {
    "Ports": [
      "http://localhost:5000/"
    ]
  }
}
```

Из этого мы можем создать обратный прокси, который будет прослушивать вашу службу и делать трафик доступным через открытую сеть.

## Проксирование вашего приложения

Проксирование вашей службы означает, что вы не будете напрямую открывать вашу службу Sisk для внешней сети. Эта практика очень распространена при развертывании серверов, потому что:

- Позволяет ассоциировать SSL-сертификат с вашим приложением;
- Создавать правила доступа перед доступом к службе и избегать перегрузок;
- Управлять пропускной способностью и ограничениями на запросы;
- Разделять балансировщики нагрузки для вашего приложения;
- Предотвращать нанесение ущерба безопасности инфраструктуре при сбое.

Вы можете обслуживать ваше приложение через обратный прокси, такой как [Nginx](https://learn.microsoft.com/en-us/aspnet/core/host-and-deploy/linux-nginx?view=aspnetcore-7.0&tabs=linux-ubuntu#install-nginx) или [Apache](https://learn.microsoft.com/en-us/aspnet/core/host-and-deploy/linux-apache?view=aspnetcore-7.0), или вы можете использовать туннель http-over-dns, такой как [Cloudflared](https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/install-and-setup/tunnel-guide/).

Также не забудьте правильно разрешить заголовки перенаправления вашего прокси, чтобы получить информацию о клиенте, такую как IP-адрес и хост, через [решатели перенаправления](/docs/advanced/forwarding-resolvers).

Следующим шагом после создания вашего туннеля, настройки брандмауэра и запуска вашего приложения является создание службы для вашего приложения.

> [!NOTE]
> Использование SSL-сертификатов непосредственно в службе Sisk на системах, отличных от Windows, невозможно. Это связано с реализацией HttpListener, которая является центральным модулем для того, как осуществляется управление очередию HTTP в Sisk, и эта реализация отличается в зависимости от операционной системы. Вы можете использовать SSL в службе Sisk, если вы [ассоциируете сертификат с виртуальным хостом с помощью IIS](https://learn.microsoft.com/en-us/iis/manage/configuring-security/how-to-set-up-ssl-on-iis). Для других систем настоятельно рекомендуется использовать обратный прокси.

## Создание службы

Создание службы сделает ваше приложение всегда доступным, даже после перезапуска экземпляра сервера или непредвиденного сбоя.

В этом простом руководстве мы будем использовать содержимое предыдущего руководства в качестве демонстрации, чтобы ваше приложение всегда было активным.

1. Перейдите в папку, где находятся файлы конфигурации службы:

    ```sh
    cd /etc/systemd/system
    ```

2. Создайте файл `my-app.service` и включите в него содержимое:

    ```ini
    [Unit]
    Description=<описание вашего приложения>

    [Service]
    # задайте пользователя, который запустит службу
    User=<пользователь, который запустит службу>

    # путь ExecStart не является относительным к WorkingDirectory.
    # задайте его как полный путь к исполняемому файлу
    WorkingDirectory=/home/htdocs
    ExecStart=/home/htdocs/my-app

    # задайте службу для автоматического перезапуска при сбое
    Restart=always
    RestartSec=3

    [Install]
    WantedBy=multi-user.target
    ```

3. Перезапустите модуль менеджера служб:

    ```sh
    sudo systemctl daemon-reload
    ```

4. Запустите новую созданную службу по имени файла, который вы задали, и проверьте, работают ли они:

    ```sh
    sudo systemctl start my-app
    sudo systemctl status my-app
    ```

5. Теперь, если ваше приложение запущено ("Active: active"), включите службу, чтобы она запускалась после перезагрузки системы:

    ```sh
    sudo systemctl enable my-app
    ```

Теперь вы готовы представить ваше приложение Sisk всему миру.

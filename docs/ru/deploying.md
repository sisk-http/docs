# Развертывание вашего приложения Sisk

Процесс развертывания приложения Sisk состоит в том, чтобы опубликовать ваш проект в производстве. Хотя процесс относительно прост, стоит отметить детали, которые могут быть опасны для безопасности и стабильности инфраструктуры развертывания.

Идеально, вы должны быть готовы развернуть ваше приложение в облаке после проведения всех возможных тестов, чтобы ваше приложение было готово.

## Публикация вашего приложения

Публикация вашего приложения Sisk или сервиса заключается в генерации бинарных файлов, готовых и оптимизированных для производства. В этом примере мы скомпилируем бинарные файлы для производства, чтобы они могли работать на машине, на которой установлен .NET Runtime.

Вам понадобится .NET SDK, установленный на вашей машине, чтобы построить ваше приложение, и .NET Runtime, установленный на целевом сервере, чтобы запустить ваше приложение. Вы можете узнать, как установить .NET Runtime на вашем Linux-сервере [здесь](https://learn.microsoft.com/en-us/dotnet/core/install/linux), [Windows](https://learn.microsoft.com/en-us/dotnet/core/install/windows?tabs=net70) и [Mac OS](https://learn.microsoft.com/en-us/dotnet/core/install/macos).

В папке, где находится ваш проект, откройте терминал и используйте команду .NET publish:

```shell
$ dotnet publish -r linux-x64 -c Release
```

Это сгенерирует ваши бинарные файлы внутри `bin/Release/publish/linux-x64`.

> [!NOTE]
> Если ваше приложение запускается с помощью пакета Sisk.ServiceProvider, вы должны скопировать ваш `service-config.json` на ваш хост-сервер вместе со всеми бинарными файлами, сгенерированными командой `dotnet publish`.
> Вы можете оставить файл предварительно настроенным, с переменными окружения, портами и хостами, а также дополнительными настройками сервера.

Следующий шаг - перенести эти файлы на сервер, где будет размещено ваше приложение.

После этого, дайте права на выполнение вашему бинарному файлу. В этом случае давайте рассмотрим, что наш проект называется "my-app":

```shell
$ cd /home/htdocs
$ chmod +x my-app
$ ./my-app
```

После запуска вашего приложения, проверьте, не выдает ли оно какие-либо сообщения об ошибках. Если оно не выдало, это означает, что ваше приложение работает.

На этом этапе, скорее всего, не будет возможно получить доступ к вашему приложению из внешней сети, поскольку правила доступа, такие как брандмауэр, не настроены. Мы рассмотрим это в следующих шагах.

У вас должна быть адрес виртуального хоста, на котором слушает ваше приложение. Это устанавливается вручную в приложении и зависит от того, как вы создаете экземпляр вашего сервиса Sisk.

Если вы **не** используете пакет Sisk.ServiceProvider, вы должны найти его там, где вы определили экземпляр вашего HttpServer:

```cs
HttpServer server = HttpServer.Emit(5000, out HttpServerConfiguration config, out var host, out var router);
// sisk должен слушать на http://localhost:5000/
```

Присвоение ListeningHost вручную:

```cs
config.ListeningHosts.Add(new ListeningHost("https://localhost:5000/", router));
```

Или если вы используете пакет Sisk.ServiceProvider, в вашем `service-config.json`:

```json
{
  "Server": { },
  "ListeningHost": {
    "Ports": [
      "http://localhost:5000/"
    ]
  }
}
```

Из этого мы можем создать обратный прокси, чтобы слушать ваш сервис и сделать трафик доступным по открытой сети.

## Проксирование вашего приложения

Проксирование вашего сервиса означает, что вы не直接 подвергаете ваш сервис Sisk внешней сети. Эта практика очень распространена для серверных развертываний, потому что:

- Позволяет присвоить сертификат SSL в вашем приложении;
- Создать правила доступа перед доступом к сервису и избежать перегрузок;
- Контролировать пропускную способность и ограничения запросов;
- Отделить балансировщики нагрузки для вашего приложения;
- Предотвратить повреждение безопасности из-за неисправной инфраструктуры.

Вы можете обслуживать ваше приложение через обратный прокси, такой как [Nginx](https://learn.microsoft.com/en-us/aspnet/core/host-and-deploy/linux-nginx?view=aspnetcore-7.0&tabs=linux-ubuntu#install-nginx) или [Apache](https://learn.microsoft.com/en-us/aspnet/core/host-and-deploy/linux-apache?view=aspnetcore-7.0), или вы можете использовать туннель http-over-dns, такой как [Cloudflared](https://developers.cloudflare.com/cloudflare-one/connections/connect-networks/install-and-setup/tunnel-guide/).

Также помните, что необходимо правильно разрешить заголовки прокси для получения информации о клиенте, такой как IP-адрес и хост, через [forwarding resolvers](/docs/advanced/forwarding-resolvers).

Следующий шаг после создания туннеля, настройки брандмауэра и запуска вашего приложения - создать сервис для вашего приложения.

> [!NOTE]
> Использование сертификатов SSL напрямую в сервисе Sisk на не-Windows системах невозможно. Это связано с реализацией HttpListener, который является центральным модулем для управления очередью HTTP в Sisk, и эта реализация варьируется от операционной системы к операционной системе. Вы можете использовать SSL в вашем сервисе Sisk, если [присвоите сертификат виртуальному хосту с помощью IIS](https://learn.microsoft.com/en-us/iis/manage/configuring-security/how-to-set-up-ssl-on-iis). Для других систем использование обратного прокси высоко рекомендуется.

## Создание сервиса

Создание сервиса сделает ваше приложение всегда доступным, даже после перезапуска вашего сервера или неисправной ошибки.

В этом простом учебнике мы будем использовать содержимое из предыдущего учебника в качестве примера, чтобы ваш сервис всегда был активен.

1. Получите доступ к папке, где находятся файлы конфигурации сервиса:

    ```sh
    cd /etc/systemd/system
    ```

2. Создайте файл `my-app.service` и включите содержимое:
    
    <div class="script-header">
        <span>
            my-app.service
        </span>
        <span>
            INI
        </span>
    </div>
    
    ```ini
    [Unit]
    Description=<описание вашего приложения>

    [Service]
    # задайте пользователя, который будет запускать сервис
    User=<пользователь, который будет запускать сервис>

    # путь к ExecStart не относителен к WorkingDirectory.
    # задайте его как полный путь к исполняемому файлу
    WorkingDirectory=/home/htdocs
    ExecStart=/home/htdocs/my-app

    # задайте сервис для перезапуска после краха
    Restart=always
    RestartSec=3

    [Install]
    WantedBy=multi-user.target
    ```

3. Перезапустите модуль сервиса:

    ```sh
    $ sudo systemctl daemon-reload
    ```

4. Запустите созданный сервис с именем файла, который вы задали, и проверьте, запущен ли он:

    ```sh
    $ sudo systemctl start my-app
    $ sudo systemctl status my-app
    ```

5. Теперь, если ваше приложение запущено ("Active: active"), включите сервис, чтобы он запускался после перезапуска системы:
    
    ```sh
    $ sudo systemctl enable my-app
    ```

Теперь вы готовы представить ваше приложение Sisk всем.